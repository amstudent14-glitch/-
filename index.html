<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ë°åÊùéÊ∏ÖÂñÆ App (Ê•µÂú∞‰∏ªÈ°åËàáËá™Ë®ÇËâ≤)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- PWA / App Icon Configuration -->
    <meta name="theme-color" content="#0d9488">
    <meta name="apple-mobile-web-app-title" content="Ê•µÂÖâÊ∏ÖÂñÆ">
    <meta name="application-name" content="Ê•µÂÖâÊ∏ÖÂñÆ">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <!-- IMPORTANT: Link to the Manifest File for PWA functionality -->
    <link rel="manifest" href="manifest.json"/> 

    <!-- Apple Touch Icon (Using a placeholder aurora icon URL) -->
    <link rel="apple-touch-icon" href="https://placehold.co/180x180/0d9488/ffffff?text=%E2%9C%88%EF%B8%8F"> 
    <link rel="icon" href="https://placehold.co/192x192/0d9488/ffffff?text=%E2%9C%88%EF%B8%8F"> 
    
    <style>
        /* --- Dynamic Theme Variables (Default to Teal) --- */
        :root {
            /* RGB values for main theme color (Teal 600) */
            --color-main-600: 5 150 105; 
            --color-main-800: 4 78 59;  
            --color-main-300: 52 211, 153; 
            --color-main-100: 209 250 229; 
            --color-main-50: 236 253 245; 
        }

        /* --- Theme Utility Classes (Using Variables) --- */
        .bg-theme { background-color: rgb(var(--color-main-600)); }
        .bg-theme-50 { background-color: rgb(var(--color-main-50)); }
        .bg-theme-300 { background-color: rgb(var(--color-main-300)); }
        .bg-theme-800 { background-color: rgb(var(--color-main-800)); }
        .text-theme-100 { color: rgb(var(--color-main-100)); }
        .text-theme-900 { color: rgb(var(--color-main-800)); }
        .focus-ring-theme-500:focus { --tw-ring-color: rgb(var(--color-main-600)); }
        .hover\:border-theme-300:hover { border-color: rgb(var(--color-main-300)); }

        /* --- Custom Checkbox Styling using Variables --- */
        .check-button.checked {
            background-color: rgb(var(--color-main-600));
            border-color: rgb(var(--color-main-600));
        }
        .check-button:hover:not(.checked) {
            border-color: rgb(var(--color-main-300)); 
        }

        /* --- General Styles --- */
        .lucide {
            display: inline-block;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        #main-header {
            z-index: 20;
        }
        dialog::backdrop {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        #nav-menu {
            transition: transform 0.3s ease-out;
            transform: translateX(100%);
            z-index: 30;
        }
        #nav-menu.open {
            transform: translateX(0);
        }
        #nav-menu-backdrop.open {
            display: block;
        }
        #nav-menu-backdrop {
            display: none;
            z-index: 25;
            background: rgba(0, 0, 0, 0.4);
        }
    </style>
</head>
<body class="bg-slate-50 font-sans" onload="initApp()">

    <!-- Navigation Drawer (Hamburger Menu) -->
    <div id="nav-menu-backdrop" class="fixed inset-0" onclick="toggleNavMenu()"></div>
    <div id="nav-menu" class="fixed top-0 right-0 h-full w-64 bg-white shadow-2xl p-6 overflow-y-auto">
        <div class="flex justify-between items-center border-b pb-3 mb-4">
            <h3 class="text-lg font-bold text-slate-700">Ê∏ÖÂñÆÂàÜÈ°û</h3>
            <button onclick="toggleNavMenu()" class="text-slate-500 hover:text-slate-700">
                <i data-lucide="x" class="lucide w-6 h-6"></i>
            </button>
        </div>
        <ul id="nav-links" class="space-y-3">
            <!-- Navigation links will be populated here -->
        </ul>
    </div>

    <!-- Main Container -->
    <div id="app-container">
        
        <!-- Header -->
        <div id="main-header" class="bg-theme text-white shadow-lg sticky top-0">
            <div class="max-w-md mx-auto px-4 py-4">
                <div class="flex justify-between items-center mb-2">
                    <!-- Editable Title -->
                    <h1 class="text-xl font-bold flex items-center gap-2 cursor-pointer" onclick="editTitle()">
                        <i data-lucide="sparkles" class="lucide w-6 h-6"></i>
                        <span id="app-title">ÈªÉÂàÄÈéÆÊ•µÂÖâ‰πãÊóÖÊ∏ÖÂñÆ</span>
                        <i data-lucide="pencil" class="lucide w-3 h-3 text-theme-100"></i>
                    </h1>
                    
                    <div class="flex space-x-3 items-center">
                        <!-- Color Picker Button -->
                        <button id="color-picker-button" class="text-theme-100 hover:text-white transition-colors" title="Êõ¥Êîπ‰∏ªÈ°åÈ°èËâ≤">
                            <i data-lucide="palette" class="lucide w-5 h-5"></i>
                        </button>
                        <!-- Trash Button -->
                        <button id="trash-button" class="text-theme-100 hover:text-red-300 transition-colors" title="ÂõûÊî∂Á´ô">
                            <i data-lucide="trash-2" class="lucide w-5 h-5"></i>
                            <span id="trash-count" class="absolute -mt-2 -ml-2 text-[10px] bg-red-500 rounded-full w-4 h-4 flex items-center justify-center text-white font-bold" style="display:none;">0</span>
                        </button>
                        <!-- Reset Button -->
                        <button id="reset-button" class="text-theme-100 hover:text-white transition-colors" title="ÈáçÁΩÆÊ∏ÖÂñÆ">
                            <i data-lucide="rotate-ccw" class="lucide w-5 h-5"></i>
                        </button>
                        <!-- Hamburger Menu Button -->
                        <button id="menu-button" class="text-theme-100 hover:text-white transition-colors" title="ÂàÜÈ°ûÂ∞éËà™" onclick="toggleNavMenu()">
                            <i data-lucide="menu" class="lucide w-6 h-6"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Progress Bar -->
                <div class="bg-theme-800 rounded-full h-4 w-full overflow-hidden">
                    <div id="progress-bar" class="bg-theme-300 h-full transition-all duration-500 ease-out flex items-center justify-end pr-2 text-[10px] font-bold text-theme-900" style="width: 0%">
                    </div>
                </div>
                <div id="progress-message" class="text-xs text-theme-100 mt-1 text-right">
                    ÁπºÁ∫åÂä†Ê≤πÔºÅ
                </div>
            </div>
        </div>

        <!-- List Content Area -->
        <div id="list-container" class="max-w-md mx-auto px-4 py-6 space-y-6 pb-12">
            <!-- List items will be rendered here by JavaScript -->
        </div>

        <div class="max-w-md mx-auto px-4 text-center text-slate-400 text-xs pb-4">
            <p class="flex items-center justify-center gap-1">
                <i data-lucide="luggage" class="lucide w-4 h-4"></i>
                Ê∫ñÂÇôÂ•ΩÂá∫Áôº‰∫ÜÂóéÔºü
            </p>
        </div>
    </div>

    <!-- Color Picker Modal -->
    <dialog id="color-modal" class="p-6 rounded-xl shadow-2xl backdrop:blur-sm max-w-sm w-full">
        <h3 class="text-xl font-bold mb-4 flex items-center gap-2 text-slate-700">
            <i data-lucide="palette" class="lucide w-5 h-5 text-teal-600"></i>
            ÈÅ∏Êìá‰∏ªÈ°åÈ°èËâ≤
        </h3>
        <div id="color-palette" class="grid grid-cols-5 gap-3 p-2">
            <!-- Colors will be rendered here -->
        </div>
        <button id="close-color-modal" class="mt-6 w-full py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition-colors">
            ÈóúÈñâ
        </button>
    </dialog>

    <!-- Trash Modal -->
    <dialog id="trash-modal" class="p-6 rounded-xl shadow-2xl backdrop:blur-sm max-w-sm w-full">
        <h3 class="text-xl font-bold text-red-600 mb-4 flex items-center gap-2">
            <i data-lucide="trash-2" class="lucide w-5 h-5"></i>
            ÂõûÊî∂Á´ô
        </h3>
        <div id="trash-content" class="text-slate-700 space-y-3 max-h-80 overflow-y-auto pr-2">
            <!-- Deleted items will be rendered here -->
        </div>
        <button id="close-trash-modal-button" class="mt-6 w-full py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition-colors">
            ÈóúÈñâ
        </button>
        <button id="empty-trash-button" class="mt-2 w-full py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
            Ê∏ÖÁ©∫ÂõûÊî∂Á´ô
        </button>
    </dialog>
    
    <!-- Title Edit Modal (Replaces prompt()) -->
    <dialog id="title-modal" class="p-6 rounded-xl shadow-2xl backdrop:blur-sm max-w-sm w-full">
        <h3 class="text-xl font-bold text-slate-700 mb-4 flex items-center gap-2">
            <i data-lucide="pencil" class="lucide w-5 h-5 text-theme"></i>
            Á∑®ËºØÊ∏ÖÂñÆÊ®ôÈ°å
        </h3>
        <input type="text" id="title-input" class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus-ring-theme-500 text-lg mb-4" maxlength="50">
        <div class="flex justify-end space-x-3">
            <button id="cancel-title-edit" class="py-2 px-4 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition-colors">ÂèñÊ∂à</button>
            <button id="save-title-edit" class="py-2 px-4 bg-theme text-white rounded-lg hover:bg-theme-800 transition-colors">ÂÑ≤Â≠ò</button>
        </div>
    </dialog>

    <!-- Generic Confirmation Modal (Replaces confirm() for Reset/Empty Trash) -->
    <dialog id="confirm-modal" class="p-6 rounded-xl shadow-2xl backdrop:blur-sm max-w-sm w-full">
        <h3 id="confirm-modal-title" class="text-xl font-bold mb-4 flex items-center gap-2 text-red-600">
            <i data-lucide="alert-triangle" class="lucide w-5 h-5"></i>
            Á¢∫Ë™çÊìç‰Ωú
        </h3>
        <p id="confirm-modal-message" class="text-slate-700 mb-6"></p>
        <div class="flex justify-end space-x-3">
            <button id="confirm-modal-cancel" class="py-2 px-4 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition-colors">ÂèñÊ∂à</button>
            <button id="confirm-modal-action" class="py-2 px-4 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">Á¢∫Ë™ç‰∏¶ÁπºÁ∫å</button>
        </div>
    </dialog>


    <script>
        // --- Storage Keys ---
        const STORAGE_KEY_ITEMS = 'packing-list-v4-items';
        const STORAGE_KEY_TRASH = 'packing-list-v4-trash';
        const STORAGE_KEY_TITLE = 'packing-list-v4-title';
        const STORAGE_KEY_COLOR = 'packing-list-v4-color';

        // --- Color Themes ---
        // RGB tuples for 600, 800 (dark), 300 (light), 100 (accent), 50 (bg)
        const COLOR_THEMES = {
            emerald: { name: 'Ê•µÂÖâÁ∂†', color: [5, 150, 105], dark: [4, 78, 59], light: [52, 211, 153], accent: [209, 250, 229], bg: [236, 253, 245] },
            blue: { name: 'ÂÜ∞Â∑ùËóç', color: [37, 99, 235], dark: [30, 64, 175], light: [96, 165, 250], accent: [219, 234, 254], bg: [239, 246, 255] },
            rose: { name: 'ËñîËñáÁ≤â', color: [225, 29, 72], dark: [159, 18, 57], light: [251, 113, 133], accent: [255, 237, 240], bg: [255, 241, 245] },
            indigo: { name: 'ÊòüÁ©∫Á¥´', color: [79, 70, 229], dark: [55, 48, 163], light: [129, 140, 248], accent: [224, 231, 255], bg: [238, 242, 255] },
            amber: { name: 'Êó•ËêΩÈªÉ', color: [245, 158, 11], dark: [180, 83, 9], light: [252, 211, 77], accent: [255, 251, 235], bg: [255, 253, 242] }, 
        };
        const DEFAULT_COLOR = 'emerald';
        let mainColorKey = DEFAULT_COLOR;

        // --- App Data (Updated for Yellowknife) ---
        
        const initialData = {
            "Ê•µÂú∞‰øùÊöñË£ùÂÇô": [
                { id: 100, text: "Èõ™Ë§≤ (Èò≤Ê∞¥Èò≤È¢®)", checked: false },
                { id: 101, text: "ÁæΩÁµ®Â§ñÂ•ó (Ê•µÂú∞Á≠âÁ¥öÔºå-30¬∞C)", checked: false },
                { id: 102, text: "‰øùÊöñÂÖßÂ±§Ë°£Ë§≤ (ÁæäÊØõÊàñÁôºÁÜ±Ë°£)", checked: false },
                { id: 103, text: "‰∏≠Â±§Ë°£Áâ© (Âà∑ÊØõÊàñËºïÁæΩÁµ®)", checked: false },
                { id: 104, text: "ÁæäÊØõË•™ (Ëá≥Â∞ë3Èõô)", checked: false },
                { id: 105, text: "Èõ™Èù¥ (Èò≤Ê∞¥Èò≤ÊªëÔºåËÄê‰ΩéÊ∫´)", checked: false },
                { id: 106, text: "Èò≤È¢®Èò≤Ê∞¥ÊâãÂ•ó (ÂÖ©Â±§ÂºèÊúÄ‰Ω≥)", checked: false },
                { id: 107, text: "ÊØõÂ∏Ω/‰øùÊöñÈ†≠Â•ó (ÈÅÆ‰ΩèËÄ≥ÊúµÂíåËáâÈ†∞)", checked: false },
                { id: 108, text: "ÊöñÊöñÂåÖ (Â§ßÈáèÔºåË≤ºÂºèËàáÊâãÊè°Âºè)", checked: false },
                { id: 109, text: "ÂúçÂ∑æ/Èù¢ÁΩ© (Èò≤È¢®Ôºå‰øùË≠∑È†∏ÈÉ®)", checked: false },
            ],
            "ÁÑ°ÊïµÈáçË¶ÅÁâ©ÂìÅ": [
                { id: 1, text: "Ë≠∑ÁÖß", checked: false },
                { id: 2, text: "ÊâãÊ©ü", checked: false },
                { id: 3, text: "SIMÂç°", checked: false },
                { id: 4, text: "Âä†Âπ£ (ÁèæÈáë)", checked: false },
                { id: 5, text: "ÂÆ∂Èë∞Âåô", checked: false },
                { id: 6, text: "Èå¢ÂåÖ", checked: false },
            ],
            "ÈõªÂ≠êËàáÊîùÂΩ±È°û": [
                { id: 37, text: "Áõ∏Ê©ü+‰∏âËÖ≥Êû∂ (Ê•µÂÖâÊãçÊîùÂøÖÂÇô)", checked: false },
                { id: 38, text: "ÂÇôÁî®ÈõªÊ±† (‰ΩéÊ∫´‰∏ãÈõªÂäõÊµÅÂ§±Âø´)", checked: false },
                { id: 39, text: "ÂÖÖÈõªÁ∑ö+ÂÖÖÈõªÈ†≠", checked: false },
                { id: 40, text: "Ë°åÂãïÈõªÊ∫ê", checked: false },
                { id: 41, text: "Á≠ÜÈõª(ÈõªÁ∑ö+ÊªëÈº†)", checked: false },
                { id: 42, text: "ËÄ≥Ê©ü", checked: false },
            ],
            "ÂåñÂ¶ùÂìÅ„ÄÅÁõ•Ê¥óËàáËó•ÂìÅ": [
                { id: 10, text: "ÁâôÂà∑ÁâôËÜè", checked: false },
                { id: 11, text: "È´ò‰øùÊøï‰π≥Ê∂≤/Èù¢Èúú (Èò≤ÂáçÂÇ∑)", checked: false },
                { id: 12, text: "Ë≠∑ÂîáËÜè (Ê•µÂ∫¶‰øùÊøï)", checked: false },
                { id: 13, text: "Âá°Â£´Êûó (Â°óÊäπËáâÈÉ®Ë£∏Èú≤Ëôï)", checked: false },
                { id: 14, text: "ÁúºËó•Ê∞¥", checked: false },
                { id: 15, text: "Â∏∏ÂÇôËó•ÂìÅ (ÊÑüÂÜíËó•„ÄÅÊ≠¢ÁóõËó•)", checked: false },
                { id: 16, text: "ÊöñËâ≤Á≥ªÂåñÂ¶ùÂìÅ", checked: false },
            ],
            "ÂÖ∂‰ªñÂøÖÈúÄÂìÅ": [
                { id: 30, text: "Èõ®ÂÇò/Â∞èÂûãÊë∫ÁñäÂÇò", checked: false },
                { id: 31, text: "‰øùÊ∫´Áì∂ (Èö®ÊôÇË£úÂÖÖÁÜ±È£≤)", checked: false },
                { id: 32, text: "Â§™ÈôΩÁúºÈè° (Èõ™Âú∞Èò≤Áú©ÂÖâ)", checked: false },
                { id: 33, text: "Ë°õÁîüÁ¥ô/ÊøïÁ¥ôÂ∑æ", checked: false },
                { id: 34, text: "Âè£ÁΩ© (Èò≤ÂØí„ÄÅ‰πæÁá•)", checked: false },
            ],
            "È°çÂ§ñ OPTIONAL": [
                { id: 45, text: "Âª∂Èï∑Á∑ö(Â§öÈ†≠ÊèíÂ∫ß)", checked: false },
                { id: 46, text: "UÂûãÊûï", checked: false },
                { id: 47, text: "Áí∞‰øùË¢ã", checked: false },
                { id: 48, text: "ÁúºÁΩ©„ÄÅËÄ≥Â°û", checked: false },
            ]
        };

        let appTitle = "ÈªÉÂàÄÈéÆÊ•µÂÖâ‰πãÊóÖÊ∏ÖÂñÆ";
        let appItems = {};
        let trashItems = []; 
        let confirmActionCallback = null; 


        // --- Storage Handlers ---

        function loadItems() {
            const savedItems = localStorage.getItem(STORAGE_KEY_ITEMS);
            // If the structure changes, you might load old data. For a new major trip, we reset.
            if (!savedItems) {
                console.log("Loading initial Yellowknife data.");
                return JSON.parse(JSON.stringify(initialData)); 
            }
            return JSON.parse(savedItems);
        }

        function loadTitle() {
            return localStorage.getItem(STORAGE_KEY_TITLE) || "ÈªÉÂàÄÈéÆÊ•µÂÖâ‰πãÊóÖÊ∏ÖÂñÆ";
        }
        
        function loadColor() {
            return localStorage.getItem(STORAGE_KEY_COLOR) || DEFAULT_COLOR;
        }
        
        function loadTrash() {
            const savedTrash = localStorage.getItem(STORAGE_KEY_TRASH);
            return savedTrash ? JSON.parse(savedTrash) : [];
        }

        function saveItems() {
            localStorage.setItem(STORAGE_KEY_ITEMS, JSON.stringify(appItems));
            localStorage.setItem(STORAGE_KEY_TRASH, JSON.stringify(trashItems));
        }
        
        function saveTitle() {
            localStorage.setItem(STORAGE_KEY_TITLE, appTitle);
            document.getElementById('app-title').textContent = appTitle;
        }
        
        function saveColor(key) {
            mainColorKey = key;
            localStorage.setItem(STORAGE_KEY_COLOR, mainColorKey);
            applyTheme();
        }


        // --- UI Logic ---
        
        function applyTheme() {
            const theme = COLOR_THEMES[mainColorKey];
            const root = document.documentElement;
            root.style.setProperty('--color-main-600', theme.color.join(' '));
            root.style.setProperty('--color-main-800', theme.dark.join(' '));
            root.style.setProperty('--color-main-300', theme.light.join(' '));
            root.style.setProperty('--color-main-100', theme.accent.join(' '));
            root.style.setProperty('--color-main-50', theme.bg.join(' '));
            
            // Re-render the list to update check-box colors and category header backgrounds
            renderList();
        }

        function calculateProgress() {
            let total = 0;
            let checked = 0;
            Object.values(appItems).forEach(categoryItems => {
                categoryItems.forEach(item => {
                    total++;
                    if (item.checked) checked++;
                });
            });
            const progress = total === 0 ? 0 : Math.round((checked / total) * 100);
            return { total, checked, progress };
        }

        function updateProgressDisplay() {
            const { checked, total, progress } = calculateProgress();
            const progressBar = document.getElementById('progress-bar');
            const progressMessage = document.getElementById('progress-message');
            const trashCount = document.getElementById('trash-count');

            progressBar.style.width = `${progress}%`;
            
            const progressBarText = progress > 5 ? `${progress}%` : '';
            if (progressBar.textContent !== progressBarText) {
                progressBar.textContent = progressBarText;
            }

            trashCount.textContent = trashItems.length > 99 ? '99+' : trashItems.length;
            trashCount.style.display = trashItems.length > 0 ? 'flex' : 'none';

            if (total > 0 && progress === 100) {
                progressMessage.textContent = "Ê•µÂú∞Ë£ùÂÇôÂ∞±Á∑íÔºÅÁ•ùÊ•µÂÖâÊçïÁç≤ÊàêÂäüÔºÅüåå";
            } else {
                progressMessage.textContent = "ÁπºÁ∫åÂä†Ê≤πÔºÅ";
            }
        }
        
        function toggleNavMenu() {
            const menu = document.getElementById('nav-menu');
            const backdrop = document.getElementById('nav-menu-backdrop');
            const isOpen = menu.classList.toggle('open');
            backdrop.classList.toggle('open', isOpen);
            document.body.style.overflow = isOpen ? 'hidden' : ''; 
        }

        function scrollToCategory(id) {
            const element = document.getElementById(id);
            if (element) {
                const headerHeight = document.getElementById('main-header').offsetHeight;
                const offsetTop = element.offsetTop - headerHeight - 16; 
                window.scrollTo({ top: offsetTop, behavior: 'smooth' });
                toggleNavMenu(); 
            }
        }

        // --- Modals (Title, Color, Confirm) ---

        function editTitle() {
            const titleModal = document.getElementById('title-modal');
            const titleInput = document.getElementById('title-input');
            
            titleInput.value = appTitle;
            titleModal.showModal();
            titleInput.focus();
        }
        
        function saveTitleEdit() {
            const titleInput = document.getElementById('title-input');
            const newTitle = titleInput.value.trim();
            
            if (newTitle !== "" && newTitle !== appTitle) {
                appTitle = newTitle;
                saveTitle();
            }
            
            document.getElementById('title-modal').close();
        }

        function renderColorModal() {
            const modal = document.getElementById('color-modal');
            const palette = document.getElementById('color-palette');

            palette.innerHTML = Object.keys(COLOR_THEMES).map(key => {
                const theme = COLOR_THEMES[key];
                const isSelected = key === mainColorKey;
                const rgb = theme.color.join(',');
                const borderClass = isSelected ? 'border-4 border-slate-800 scale-105' : 'border-2 border-slate-300';
                
                return `
                    <div class="flex flex-col items-center">
                        <button 
                            class="color-option w-10 h-10 rounded-full shadow-md transition-transform transform hover:scale-110 ${borderClass}" 
                            style="background-color: rgb(${rgb})" 
                            data-color-key="${key}"
                            aria-label="${theme.name}"
                        ></button>
                        <span class="text-xs mt-1 text-slate-600">${theme.name}</span>
                    </div>
                `;
            }).join('');
            
            palette.querySelectorAll('.color-option').forEach(btn => {
                btn.onclick = () => {
                    saveColor(btn.dataset.colorKey);
                    modal.close();
                };
            });

            modal.showModal();
        }
        
        function showConfirm(title, message, callback) {
            const modal = document.getElementById('confirm-modal');
            // Update modal title and icon color (using red for confirmation warnings)
            document.getElementById('confirm-modal-title').innerHTML = `<i data-lucide="alert-triangle" class="lucide w-5 h-5 text-red-600"></i> ${title}`;
            document.getElementById('confirm-modal-message').textContent = message;
            confirmActionCallback = callback;
            lucide.createIcons();
            modal.showModal();
        }

        function triggerResetList() {
            showConfirm(
                "ÈáçÁΩÆÊ∏ÖÂñÆË≠¶Âëä",
                "Á¢∫ÂÆöË¶Å„ÄêÂÆåÂÖ®ÈáçÁΩÆ„ÄëÊâÄÊúâÊ∏ÖÂñÆ„ÄÅÂà™Èô§Êñ∞Â¢ûÈ†ÖÁõÆÔºå‰∏¶Ê∏ÖÁ©∫ÂõûÊî∂Á´ôÂóéÔºüÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÈÇÑÂéüÔºÅ",
                resetListLogic
            );
        }

        function resetListLogic() {
            appItems = JSON.parse(JSON.stringify(initialData)); 
            trashItems = [];
            appTitle = "ÈªÉÂàÄÈéÆÊ•µÂÖâ‰πãÊóÖÊ∏ÖÂñÆ";
            mainColorKey = DEFAULT_COLOR;
            localStorage.clear(); 
            saveTitle(); 
            saveColor(DEFAULT_COLOR); // Save default color and apply theme
            saveItems();
            renderList();
            document.getElementById('confirm-modal').close();
        }

        function triggerEmptyTrash() {
            showConfirm(
                "Ê∏ÖÁ©∫ÂõûÊî∂Á´ôË≠¶Âëä",
                "Á¢∫ÂÆöË¶ÅÊ∞∏‰πÖÊ∏ÖÁ©∫ÂõûÊî∂Á´ôÂóéÔºüÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÈÇÑÂéüÔºÅ",
                emptyTrashLogic
            );
        }

        function emptyTrashLogic() {
            trashItems = [];
            saveItems();
            renderTrashModal();
            updateProgressDisplay();
            document.getElementById('confirm-modal').close();
        }


        // --- Item CRUD Handlers ---

        function toggleCheck(category, id) {
            appItems[category] = appItems[category].map(item => 
                item.id === id ? { ...item, checked: !item.checked } : item
            );
            saveItems();
            renderList();
        }

        function deleteItem(category, id) {
            const index = appItems[category].findIndex(item => item.id === id);
            if (index > -1) {
                const [deletedItem] = appItems[category].splice(index, 1);
                deletedItem.category = category; 
                trashItems.push(deletedItem);
                
                // Only delete the category if it's NOT one of the initial categories
                if (appItems[category].length === 0 && !Object.keys(initialData).includes(category)) {
                    delete appItems[category];
                }

                saveItems();
                renderList();
            }
        }
        
        function restoreItem(id) {
            const index = trashItems.findIndex(item => item.id === id);
            if (index > -1) {
                const [restoredItem] = trashItems.splice(index, 1);
                const category = restoredItem.category || "È°çÂ§ñ OPTIONAL";
                
                if (!appItems[category]) {
                    appItems[category] = [];
                }
                
                appItems[category].push({ 
                    id: restoredItem.id, 
                    text: restoredItem.text, 
                    checked: restoredItem.checked 
                });
                
                saveItems();
                renderList();
                renderTrashModal(); 
            }
        }

        function handleAddItem(category) {
            const input = document.getElementById(`new-item-input-${category}`);
            const text = input.value.trim();
            if (!text) return;

            const newItem = {
                id: Date.now(),
                text: text,
                checked: false
            };

            if (!appItems[category]) {
                appItems[category] = [];
            }

            appItems[category].push(newItem);
            input.value = '';
            saveItems();
            renderList();
        }
        
        // --- Rendering ---
        
        function renderNavMenu() {
            const navLinksContainer = document.getElementById('nav-links');
            const categories = Object.keys(appItems);
            
            navLinksContainer.innerHTML = categories.map(category => `
                <li>
                    <a href="javascript:void(0)" onclick="scrollToCategory('category-${category.replace(/\s/g, '-')}')"
                       class="block px-3 py-2 text-slate-700 hover:bg-theme-50 rounded-lg transition-colors">
                        ${category}
                    </a>
                </li>
            `).join('');
        }

        function renderCategory(category, items) {
            const finishedCount = items.filter(i => i.checked).length;
            const totalCount = items.length;
            const isComplete = totalCount > 0 && finishedCount === totalCount;
            // Use bg-theme-50 for completed categories
            const bgColor = isComplete ? 'bg-theme-50' : 'bg-slate-50'; 
            const categoryId = `category-${category.replace(/\s/g, '-')}`;
            
            // Icon for important category
            const importantIcon = category === "ÁÑ°ÊïµÈáçË¶ÅÁâ©ÂìÅ" ? '<span class="text-red-500">!!!!</span>' : '';
            // Icon for cold category
            const coldIcon = category === "Ê•µÂú∞‰øùÊöñË£ùÂÇô" ? '<i data-lucide="snowflake" class="lucide w-5 h-5 text-blue-500"></i>' : '';

            // Item list HTML
            const itemsHtml = items.map(item => `
                <div class="group flex items-center p-3 hover:bg-slate-50 transition-colors ${item.checked ? 'bg-slate-50/50' : ''}">
                    <!-- Check Button -->
                    <button type="button" class="check-button flex-shrink-0 w-6 h-6 rounded-md border-2 mr-3 flex items-center justify-center transition-all ${
                        item.checked 
                            ? 'checked text-white' // The 'checked' class applies dynamic color via CSS var
                            : 'border-slate-300 text-transparent hover:border-theme-300' // Use theme 300 for hover border
                    }" data-category="${category}" data-id="${item.id}" aria-label="ÂãæÈÅ∏È†ÖÁõÆ">
                        <i data-lucide="check" class="lucide w-4 h-4" stroke-width="3"></i>
                    </button>
                    
                    <!-- Text (Clickable to toggle check) -->
                    <span 
                        class="flex-grow cursor-pointer select-none text-sm transition-all ${item.checked ? 'text-slate-400 line-through' : 'text-slate-700'}"
                        data-category="${category}" data-id="${item.id}"
                    >
                        ${item.text}
                    </span>
                    
                    <!-- Delete Button -->
                    <button type="button" class="delete-button flex-shrink-0 text-slate-300 hover:text-red-500 p-2 transition-colors active:scale-95 cursor-pointer"
                        data-category="${category}" data-id="${item.id}" aria-label="Âà™Èô§È†ÖÁõÆ">
                        <i data-lucide="trash-2" class="lucide w-4 h-4"></i>
                    </button>
                </div>
            `).join('');

            // Category block HTML
            return `
                <div id="${categoryId}" class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <!-- Category Header -->
                    <div class="px-4 py-3 border-b border-slate-100 flex justify-between items-center ${bgColor}">
                        <h2 class="font-bold text-slate-700 flex items-center gap-2 text-lg">
                            ${importantIcon}
                            ${coldIcon}
                            ${category}
                        </h2>
                        <span class="text-xs px-2 py-1 rounded-full ${isComplete ? 'bg-theme-100 text-theme-900' : 'bg-slate-200 text-slate-600'}">
                            ${finishedCount}/${totalCount}
                        </span>
                    </div>

                    <!-- Items List -->
                    <div class="divide-y divide-slate-100">
                        ${itemsHtml}
                    </div>

                    <!-- Add Item Input -->
                    <div class="p-3 bg-slate-50 border-t border-slate-100">
                        <div class="relative">
                            <input
                                type="text"
                                id="new-item-input-${category}"
                                placeholder="Êñ∞Â¢û${category}È†ÖÁõÆ..."
                                class="w-full pl-3 pr-10 py-2 text-sm border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus-ring-theme-500 focus:border-transparent transition-shadow"
                                onkeydown="if(event.key === 'Enter') { handleAddItem('${category}'); }"
                            />
                            <button
                                type="button"
                                onclick="handleAddItem('${category}')"
                                class="absolute right-1 top-1 p-1.5 bg-theme text-white rounded-md hover:bg-theme-800 disabled:bg-slate-300 disabled:cursor-not-allowed transition-colors"
                            >
                                <i data-lucide="plus" class="lucide w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderTrashModal() {
            const modal = document.getElementById('trash-modal');
            const contentDiv = document.getElementById('trash-content');
            
            if (trashItems.length === 0) {
                contentDiv.innerHTML = '<p class="text-center text-slate-500 py-6">ÂõûÊî∂Á´ôÊòØÁ©∫ÁöÑ„ÄÇ</p>';
                document.getElementById('empty-trash-button').disabled = true;
                document.getElementById('empty-trash-button').classList.add('opacity-50', 'cursor-not-allowed');
                return;
            }
            
            document.getElementById('empty-trash-button').disabled = false;
            document.getElementById('empty-trash-button').classList.remove('opacity-50', 'cursor-not-allowed');

            contentDiv.innerHTML = trashItems.map(item => `
                <div class="flex justify-between items-center bg-slate-100 p-3 rounded-lg border border-slate-200">
                    <div class="text-sm">
                        <p class="font-semibold text-slate-700">${item.text}</p>
                        <p class="text-xs text-slate-500">ÂàÜÈ°û: ${item.category || 'Â∑≤Âà™Èô§'}</p>
                    </div>
                    <button class="restore-button bg-theme text-white p-2 rounded-lg hover:bg-theme-800 transition-colors"
                        data-id="${item.id}" title="ÈÇÑÂéüÈ†ÖÁõÆ">
                        <i data-lucide="undo-2" class="lucide w-4 h-4"></i>
                    </button>
                </div>
            `).join('');
            
            lucide.createIcons();
            
            contentDiv.querySelectorAll('.restore-button').forEach(btn => {
                btn.onclick = (e) => {
                    e.stopPropagation();
                    const id = parseInt(btn.dataset.id);
                    restoreItem(id);
                };
            });
        }
        

        function renderList() {
            const container = document.getElementById('list-container');
            container.innerHTML = Object.entries(appItems).map(([category, items]) => {
                return renderCategory(category, items);
            }).join('');
            
            document.getElementById('app-title').textContent = appTitle;
            
            // Re-render icons after adding new content, and apply theme colors to new buttons
            lucide.createIcons(); 
            updateProgressDisplay();
            renderNavMenu(); 
            attachEventListeners();
        }

        function attachEventListeners() {
            const listContainer = document.getElementById('list-container');
            
            // Clear old listeners before attaching new ones (important for re-render)
            document.querySelectorAll('.check-button, .delete-button, .flex-grow').forEach(el => {
                el.onclick = null;
            });
            document.getElementById('reset-button').onclick = null;
            document.getElementById('trash-button').onclick = null;
            document.getElementById('close-trash-modal-button').onclick = null;
            document.getElementById('empty-trash-button').onclick = null;
            document.getElementById('color-picker-button').onclick = null;
            document.getElementById('close-color-modal').onclick = null;
            document.getElementById('save-title-edit').onclick = null;
            document.getElementById('cancel-title-edit').onclick = null;
            document.getElementById('confirm-modal-cancel').onclick = null;
            document.getElementById('confirm-modal-action').onclick = null;


            // Item clicks (check, delete)
            listContainer.querySelectorAll('.check-button, .delete-button, .flex-grow').forEach(el => {
                el.onclick = (e) => {
                    const category = el.dataset.category;
                    const id = parseInt(el.dataset.id);
                    
                    if (el.classList.contains('delete-button')) {
                        e.stopPropagation();
                        deleteItem(category, id);
                    } else {
                        e.stopPropagation();
                        toggleCheck(category, id);
                    }
                };
            });

            // --- Global Button Listeners ---
            document.getElementById('reset-button').onclick = triggerResetList; 
            
            // Color Modal
            document.getElementById('color-picker-button').onclick = renderColorModal;
            document.getElementById('close-color-modal').onclick = () => {
                document.getElementById('color-modal').close();
            };

            // Trash Modal buttons
            document.getElementById('trash-button').onclick = () => {
                renderTrashModal(); 
                document.getElementById('trash-modal').showModal();
            };
            document.getElementById('close-trash-modal-button').onclick = () => {
                document.getElementById('trash-modal').close();
            };
            document.getElementById('empty-trash-button').onclick = triggerEmptyTrash; 

            // --- Title Modal listeners ---
            document.getElementById('save-title-edit').onclick = saveTitleEdit;
            document.getElementById('cancel-title-edit').onclick = () => {
                document.getElementById('title-modal').close();
            };
            document.getElementById('title-input').addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault(); 
                    saveTitleEdit();
                }
            });

            // --- Confirmation Modal listeners ---
            document.getElementById('confirm-modal-cancel').onclick = () => {
                document.getElementById('confirm-modal').close();
                confirmActionCallback = null; 
            };
            document.getElementById('confirm-modal-action').onclick = () => {
                if (confirmActionCallback) {
                    confirmActionCallback(); 
                }
            };

        }

        function initApp() {
            // Load theme first
            mainColorKey = loadColor();
            applyTheme();
            
            // Load list data
            appTitle = loadTitle();
            appItems = loadItems();
            trashItems = loadTrash();
            
            // Render everything
            renderList();
        }
    </script>
</body>
</html>